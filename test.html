<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"
    />

    <meta name="mobile-web-app-capable" content="yes" />
    <link rel="apple-touch-icon" href="img/Touch-Icon.jpg" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <link rel="preconnect" href="https://unpkg.com" />
    <title>EPhone</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js" defer></script>
    <link
      rel="preload"
      href="style.css"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript><link rel="stylesheet" href="style.css" /></noscript>
    <meta name="theme-color" content="#000000" />
  </head>

  <body>
    <div id="phone-frame">
      <div class="notch"></div>
      <div id="phone-screen">
        <div id="status-bar">
          <span id="status-bar-time">12:00</span>
          <div id="status-bar-battery" class="battery-container">
            <span class="battery-text">--%</span>
            <div class="battery-icon">
              <div class="battery-level"></div>
            </div>
          </div>
        </div>
        <div id="notification-bar">
          <img id="notification-avatar" src="" />
          <div id="notification-content">
            <div class="name"></div>
            <div class="message"></div>
          </div>
        </div>

        <div id="home-screen" class="screen active">
          <div id="clock-container">
            <div id="main-time">12:00</div>
            <div id="main-date">星期一, 1月1日</div>
          </div>
          <div id="app-grid">
            <div class="app-row">
              <div class="app-icon" data-screen="world-book-screen">
                <div class="icon-bg">
                  <img id="icon-img-world-book" src="img/World-Book.jpg" alt="世界书" />
                </div>
                <span class="label">世界书</span>
              </div>
              <div class="app-icon" data-screen="chat-list-screen">
                <div class="icon-bg">
                  <img id="icon-img-qq" src="img/QQ.jpg" alt="QQ" />
                </div>
                <span class="label">QQ</span>
              </div>
            </div>
            <div class="app-row">
              <div class="app-icon" data-screen="api-settings-screen">
                <div class="icon-bg">
                  <img id="icon-img-api-settings" src="img/API.jpg" alt="API设置" />
                </div>
                <span class="label">API设置</span>
              </div>
              <div class="app-icon" data-screen="wallpaper-screen">
                <div class="icon-bg">
                  <img id="icon-img-wallpaper" src="img/Wallpaper.jpg" alt="外观设置" />
                </div>
                <span class="label">外观设置</span>
              </div>
              <div class="app-icon" data-screen="font-settings-screen">
                <div class="icon-bg">
                  <img id="icon-img-font" src="img/Font.jpg" alt="字体" />
                </div>
                <span class="label">字体</span>
              </div>
            </div>
          </div>
        </div>

        <div id="world-book-screen" class="screen">
          <div class="header">
            <button type="button" class="back-btn" onclick="showScreen('home-screen')">‹</button>
            <span>世界书</span>
            <div class="header-actions">
              <button type="button" class="action-btn" id="manage-world-book-categories-btn">
                管理分类
              </button>
              <button type="button" class="action-btn" id="add-world-book-btn">+</button>
            </div>
          </div>
          <div id="world-book-list"></div>
        </div>
        <div id="world-book-editor-screen" class="screen">
          <div class="header">
            <button type="button" class="back-btn" onclick="showScreen('world-book-screen')">
              ‹
            </button>
            <span id="world-book-editor-title">编辑世界书</span>
            <button type="button" class="save-btn" id="save-world-book-btn">保存</button>
          </div>
          <div class="form-container">
            <div class="form-group">
              <label for="world-book-name-input">书名</label>
              <input type="text" id="world-book-name-input" placeholder="请输入世界书的名称..." />
            </div>
            <div class="form-group">
              <label for="world-book-category-select">分类</label>
              <select id="world-book-category-select">
                <!-- 选项将由JS动态生成 -->
              </select>
            </div>
            <div class="form-group" style="height: 100%">
              <label for="world-book-content-input">内容</label>
              <textarea
                id="world-book-content-input"
                placeholder="在此处输入详细的世界观设定..."
              ></textarea>
            </div>
          </div>
        </div>

        <div id="api-settings-screen" class="screen">
          <div class="header">
            <button type="button" class="back-btn" onclick="showScreen('home-screen')">‹</button>
            <span>API 设置</span>
            <span style="width: 30px"></span>
          </div>
          <div class="form-container">
            <div class="form-group">
              <label>API 配置管理</label>
              <div id="api-configs-list">
                <!-- API 配置列表将由 JS 动态生成 -->
              </div>
              <button
                type="button"
                class="form-button form-button-secondary"
                id="add-new-config-btn"
                style="margin-top: 15px"
              >
                + 添加新配置
              </button>
            </div>

            <hr style="margin: 20px 0; opacity: 0.3" />

            <div class="form-group form-group-flex">
              <label for="background-activity-switch" style="margin-bottom: 0">
                启用后台角色活动
                <p style="font-size: 12px; font-weight: normal; color: #ff6b6b; margin-top: 5px">
                  警告：此功能会显著增加API调用和费用！
                </p>
              </label>
              <input
                type="checkbox"
                id="background-activity-switch"
                style="width: auto; height: 20px"
              />
            </div>
            <div class="form-group form-group-flex" style="margin-top: 10px">
              <label for="background-interval-input" style="margin-bottom: 0">
                后台活动检测间隔 (秒)
                <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px">
                  建议值 60-300。值越大，费用越低，但角色反应越慢。
                </p>
              </label>
              <input
                type="number"
                id="background-interval-input"
                min="30"
                value="60"
                style="width: 80px; text-align: center"
              />
            </div>
            <div class="form-group form-group-flex" style="margin-top: 10px">
              <label for="block-cooldown-input" style="margin-bottom: 0">
                AI被拉黑后冷静期 (小时)
                <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px">
                  被拉黑超过这个时间后，AI才有几率重新申请好友。
                </p>
              </label>
              <input
                type="number"
                id="block-cooldown-input"
                min="0.1"
                step="0.1"
                value="1"
                style="width: 80px; text-align: center"
              />
            </div>
            <div class="form-group form-group-flex" style="margin-top: 10px">
              <label for="frameless-on-mobile-switch" style="margin-bottom: 0">
                在手机端启用无边框模式
                <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px">
                  开启后，在移动设备上将隐藏手机外框以填充整个屏幕。
                </p>
              </label>
              <label class="toggle-switch">
                <input type="checkbox" id="frameless-on-mobile-switch" />
                <span class="slider"></span>
              </label>
            </div>

            <hr style="margin: 20px 0; opacity: 0.3" />

            <button type="button" class="form-button" id="export-data-btn">导出数据</button>
            <button type="button" class="form-button" id="import-btn">导入备份文件</button>
            <input id="import-data-input" type="file" accept="application/json" hidden />
          </div>
        </div>

        <div id="chat-list-screen" class="screen">
          <div class="header" id="main-chat-list-header">
            <button type="button" class="back-btn" onclick="showScreen('home-screen')">‹</button>
            <span id="chat-list-title">消息</span>
            <div class="header-actions">
              <button type="button" class="action-btn" id="add-group-chat-btn" title="创建群聊">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M21 21L19 19"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
              <button type="button" class="action-btn" id="add-chat-btn">+</button>
            </div>
          </div>

          <div id="messages-view" class="chat-list-view active">
            <div id="chat-list"></div>
          </div>

          <div id="qzone-screen" class="chat-list-view">
            <div class="qzone-header">
              <button type="button" class="back-btn" id="qzone-back-btn">‹</button>
              <span>好友动态</span>
            </div>
            <div class="qzone-content">
              <div class="qzone-profile-header">
                <div id="qzone-banner-container" class="qzone-banner-container">
                  <img id="qzone-banner-img" src="img/Banner.gif" alt="背景" />
                  <input type="file" id="qzone-banner-input" accept="image/*" hidden />
                </div>
                <div class="qzone-user-info">
                  <div id="qzone-avatar-container" class="qzone-avatar-container">
                    <img id="qzone-avatar-img" src="img/Avatar.jpeg" alt="头像" />
                    <input type="file" id="qzone-avatar-input" accept="image/*" hidden />
                  </div>
                  <span id="qzone-nickname">{{user}}</span>
                </div>
              </div>
              <div class="qzone-actions-bar">
                <div class="action-item" id="create-shuoshuo-btn"><span>说说</span></div>
                <div class="action-item" id="create-post-btn"><span>动态</span></div>
                <div class="action-item" id="open-album-btn"><span>相册</span></div>
              </div>
              <div id="qzone-posts-list"></div>
            </div>
          </div>

          <div id="favorites-view" class="chat-list-view">
            <div class="header">
              <button type="button" class="back-btn" id="favorites-back-btn">‹</button>
              <span>我的收藏</span>
              <button type="button" class="action-btn" id="favorites-edit-btn">编辑</button>
            </div>
            <div class="search-bar-container">
              <input
                type="search"
                id="favorites-search-input"
                placeholder="搜索收藏的标题、内容或作者..."
              />
              <button
                type="button"
                id="favorites-search-clear-btn"
                class="search-clear-btn"
                style="display: none"
              >
                ×
              </button>
            </div>
            <div id="favorites-list" class="list-container"></div>
            <div id="favorites-action-bar" style="display: none">
              <button type="button" id="favorites-delete-selected-btn" class="action-bar-btn">
                删除 (0)
              </button>
            </div>
          </div>

          <div id="memories-view" class="chat-list-view">
            <div class="header">
              <button type="button" class="back-btn" id="memories-back-btn">‹</button>
              <span>我们的回忆</span>
              <button type="button" class="action-btn" id="add-countdown-btn">+</button>
            </div>
            <div
              id="memories-list"
              class="list-container"
              style="padding: 15px; display: flex; flex-direction: column; gap: 15px"
            ></div>
          </div>

          <div id="chat-list-bottom-nav">
            <div class="nav-item active" data-view="messages-view"><span>消息</span></div>
            <div class="nav-item" data-view="qzone-screen"><span>动态</span></div>
            <div class="nav-item" data-view="memories-view"><span>回忆</span></div>
            <div class="nav-item" data-view="favorites-view"><span>收藏</span></div>
          </div>
        </div>

        <div id="album-screen" class="screen">
          <div class="header">
            <button type="button" class="back-btn" id="album-back-btn">‹</button>
            <span>我的相册</span>
            <button type="button" class="action-btn" id="create-album-btn-page">+</button>
          </div>
          <div class="list-container">
            <div id="album-grid-page"></div>
          </div>
        </div>

        <div id="album-photos-screen" class="screen">
          <div class="header">
            <button type="button" class="back-btn" id="album-photos-back-btn">‹</button>
            <span id="album-photos-title">相册名称</span>
            <button type="button" class="action-btn" id="album-upload-photo-btn">上传</button>
          </div>
          <div class="list-container">
            <div id="photos-grid-page"></div>
            <div id="photo-viewer-modal" class="modal">
              <button type="button" id="photo-viewer-close-btn">×</button>
              <button type="button" id="photo-viewer-prev-btn" class="nav-arrow">‹</button>
              <div class="photo-viewer-content">
                <img id="photo-viewer-image" src="" alt="全屏照片预览" />
              </div>
              <button type="button" id="photo-viewer-next-btn" class="nav-arrow">›</button>
            </div>
          </div>
        </div>

        <input type="file" id="album-photo-input" accept="image/*" multiple hidden />

        <div id="chat-interface-screen" class="screen">
          <div class="header">
            <div class="default-controls">
              <button type="button" class="back-btn" id="back-to-list-btn">‹</button>
              <div id="chat-header-title-wrapper">
                <span id="chat-header-title">聊天对象</span>
                <div id="chat-header-status">
                  <span class="status-dot"></span>
                  <span class="status-text">在线</span>
                </div>
              </div>
              <div class="header-actions">
                <button type="button" class="action-btn" id="listen-together-btn" title="一起听">
                  <img src="img/Listen-Together.png" alt="一起听" />
                </button>
                <button type="button" class="action-btn" id="chat-settings-btn" title="聊天设置">
                  <img src="img/Chat-Settings.png" alt="设置" />
                </button>
              </div>
            </div>
            <div class="selection-controls">
              <button type="button" id="selection-cancel-btn">取消</button>
              <span id="selection-count"></span>
              <div class="header-actions">
                <button type="button" id="selection-favorite-btn" class="action-btn">收藏</button>
                <button type="button" id="selection-share-btn" class="action-btn">分享</button>
                <button
                  type="button"
                  id="selection-delete-btn"
                  class="action-btn"
                  style="color: #ff3b30"
                >
                  删除
                </button>
              </div>
            </div>
          </div>
          <div id="chat-messages">
            <div id="typing-indicator">对方正在输入...</div>
          </div>
          <div id="chat-input-area">
            <div id="reply-preview-bar">
              <div class="reply-preview-content">
                <div class="sender">回复 xxx:</div>
                <div class="text">被引用的消息内容...</div>
              </div>
              <button type="button" id="cancel-reply-btn" class="action-button">×</button>
            </div>
            <div id="chat-input-actions-top">
              <button
                type="button"
                id="open-sticker-panel-btn"
                class="chat-action-icon-btn action-button"
                title="表情面板"
              >
                +
              </button>
              <button
                type="button"
                id="send-photo-btn"
                class="chat-action-icon-btn action-button"
                title="发送照片"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"
                  />
                  <circle cx="12" cy="13" r="4" />
                </svg>
              </button>
              <button
                type="button"
                id="upload-image-btn"
                class="chat-action-icon-btn action-button"
                title="上传图片"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  style="color: var(--text-primary)"
                >
                  <path
                    d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
              <button
                type="button"
                id="transfer-btn"
                class="chat-action-icon-btn action-button"
                title="转账"
              >
                ￥
              </button>
              <button
                type="button"
                id="voice-message-btn"
                class="chat-action-icon-btn action-button"
                title="发送语音"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                  <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                  <path d="M12 19v4" />
                  <path d="M8 23h8" />
                </svg>
              </button>
              <button
                type="button"
                id="send-waimai-request-btn"
                class="chat-action-icon-btn action-button"
                title="发起外卖请求"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z" />
                  <line x1="3" y1="6" x2="21" y2="6" />
                  <path d="M16 10a4 4 0 0 1-8 0" />
                </svg>
              </button>
              <button
                type="button"
                id="video-call-btn"
                class="chat-action-icon-btn action-button"
                title="视频通话"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <polygon points="23 7 16 12 23 17 23 7"></polygon>
                  <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                </svg>
              </button>
              <button
                type="button"
                id="group-video-call-btn"
                class="chat-action-icon-btn action-button"
                title="群视频通话"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
              </button>
              <button
                type="button"
                id="send-poll-btn"
                class="chat-action-icon-btn action-button"
                title="发起投票"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M8 6h10" />
                  <path d="M6 6h.01" />
                  <path d="M8 12h10" />
                  <path d="M6 12h.01" />
                  <path d="M8 18h10" />
                  <path d="M6 18h.01" />
                </svg>
              </button>
              <button
                type="button"
                id="share-link-btn"
                class="chat-action-icon-btn action-button"
                title="分享链接"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path>
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path>
                </svg>
              </button>
            </div>
            <div id="chat-input-main-row">
              <textarea id="chat-input" rows="1" placeholder="输入消息..."></textarea>
              <div id="input-actions-wrapper">
                <button type="button" id="wait-reply-btn" title="等待回复">
                  <img src="img/Wait-Reply.png" alt="等待回复" />
                </button>
                <button type="button" id="retry-btn" title="重试" style="display: none">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="white"
                  >
                    <path
                      d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"
                    />
                  </svg>
                </button>
                <button type="button" id="send-btn" class="action-button">发送</button>
              </div>
            </div>
          </div>

          <div id="chat-lock-overlay">
            <div id="chat-lock-content"></div>
          </div>

          <div id="sticker-panel">
            <div id="sticker-panel-header">
              <button type="button" class="panel-btn" id="close-sticker-panel-btn">取消</button>
              <span class="title">我的表情</span>
              <div style="display: flex; gap: 10px">
                <button type="button" class="panel-btn" id="add-sticker-btn">添加</button>
                <button type="button" class="panel-btn" id="upload-sticker-btn">上传</button>
              </div>
            </div>
            <div id="sticker-grid"></div>
          </div>
          <input type="file" id="sticker-upload-input" accept="image/*" style="display: none" />
          <input type="file" id="image-upload-input" accept="image/*" style="display: none" />

          <div id="music-player-overlay">
            <div class="music-player-window">
              <div class="music-player-top-actions">
                <div class="top-left-cluster">
                  <button type="button" id="music-return-btn">‹</button>
                  <button type="button" id="music-exit-btn">×</button>
                </div>
                <button type="button" id="music-playlist-btn">☰</button>
              </div>
              <div id="music-time-counter">已经一起听了0.0小时</div>
              <div id="music-player-song-title">请添加歌曲</div>
              <div id="music-player-artist">...</div>
              <div id="music-lyrics-container">
                <div id="music-lyrics-list">
                  <div class="lyric-line">♪ 暂无歌词 ♪</div>
                </div>
              </div>
              <div class="music-player-controls-wrapper">
                <div class="music-progress-bar-container">
                  <div id="music-current-time" class="time-display">0:00</div>
                  <div class="progress-bar">
                    <div id="music-progress-fill" class="progress-bar-fill"></div>
                  </div>
                  <div id="music-total-time" class="time-display">0:00</div>
                </div>
                <div class="music-controls">
                  <button type="button" id="music-prev-btn">◀</button>
                  <button type="button" id="music-play-pause-btn" class="play-pause-btn">▶</button>
                  <button type="button" id="music-next-btn">▶</button>
                  <button type="button" id="music-mode-btn">顺序</button>
                </div>
              </div>
            </div>
          </div>

          <div id="music-playlist-panel">
            <div class="playlist-header">
              <button type="button" class="panel-btn" id="close-playlist-btn">返回</button>
              <span>播放列表</span>
              <div>
                <button type="button" class="panel-btn" id="add-song-local-btn">本地</button>
                <button type="button" class="panel-btn" id="add-song-url-btn">URL</button>
              </div>
            </div>
            <div class="playlist-body" id="playlist-body"></div>
          </div>
          <input
            type="file"
            id="local-song-upload-input"
            accept="audio/*"
            multiple
            style="display: none"
          />
          <input type="file" id="lrc-upload-input" accept=".lrc" style="display: none" />
        </div>

        <div id="wallpaper-screen" class="screen">
          <div class="header">
            <button type="button" class="back-btn" onclick="showScreen('home-screen')">‹</button>
            <span>外观设置</span>
            <span style="width: 30px"></span>
          </div>
          <div class="form-container">
            <div id="wallpaper-preview">点击下方上传</div>
            <button
              type="button"
              class="form-button"
              onclick="document.getElementById('wallpaper-upload-input').click();"
            >
              上传壁纸
            </button>
            <input type="file" id="wallpaper-upload-input" accept="image/*" />
            <div class="form-group form-group-flex">
              <label for="theme-toggle-switch" style="margin-bottom: 0">夜间模式</label>
              <label class="toggle-switch">
                <input type="checkbox" id="theme-toggle-switch" />
                <span class="slider"></span>
              </label>
            </div>
            <hr style="width: 80%; opacity: 0.3; margin: 30px 0" />
            <div style="width: 100%; text-align: left; margin-bottom: 15px">
              <label style="font-weight: 500; color: var(--text-secondary)">App 图标设置</label>
            </div>
            <div id="icon-settings-grid"></div>
            <hr style="width: 80%; opacity: 0.3; margin: 30px 0" />
            <div style="width: 100%; text-align: left; margin-bottom: 15px">
              <label style="font-weight: 500; color: var(--text-secondary)">手机外框颜色</label>
            </div>
            <div id="frame-color-presets">
              <div
                class="color-swatch"
                data-color="#ffffff"
                style="background-color: #ffffff"
              ></div>
              <div
                class="color-swatch"
                data-color="#f0f2f5"
                style="background-color: #f0f2f5"
              ></div>
              <div
                class="color-swatch"
                data-color="#1f1f1f"
                style="background-color: #1f1f1f"
              ></div>
              <div
                class="color-swatch"
                data-color="#ffc0cb"
                style="background-color: #ffc0cb"
              ></div>
              <div
                class="color-swatch"
                data-color="#add8e6"
                style="background-color: #add8e6"
              ></div>
            </div>
            <div
              id="custom-frame-color-group"
              class="form-group"
              style="margin-top: 15px; width: 100%"
            >
              <label for="custom-frame-color-input" style="font-size: 12px"
                >或输入自定义颜色 (如: #RRGGBB)</label
              >
              <div style="display: flex; gap: 10px">
                <input
                  type="text"
                  id="custom-frame-color-input"
                  placeholder="#ffffff"
                  style="flex-grow: 1; padding: 8px"
                />
                <button
                  type="button"
                  id="apply-custom-frame-color-btn"
                  class="form-button-secondary"
                  style="margin-top: 0; padding: 0 15px"
                >
                  应用
                </button>
              </div>
            </div>
            <button
              type="button"
              class="form-button"
              id="save-wallpaper-btn"
              style="margin-top: 30px"
            >
              保存所有外观设置
            </button>
          </div>
        </div>

        <div id="browser-screen" class="screen">
          <div class="header">
            <button type="button" class="back-btn" id="browser-back-btn">‹</button>
            <span id="browser-title"></span>
            <span style="width: 30px"></span>
          </div>
          <div id="browser-content" class="list-container"></div>
        </div>

        <div id="font-settings-screen" class="screen">
          <div class="header">
            <button type="button" class="back-btn" onclick="showScreen('home-screen')">‹</button>
            <span>字体设置</span>
            <span style="width: 30px"></span>
          </div>
          <div class="form-container">
            <div class="form-group">
              <label for="font-url-input">字体文件URL (.ttf, .otf, .woff等)</label>
              <input type="text" id="font-url-input" placeholder="https://..../font.ttf" />
            </div>
            <div class="form-group">
              <label>实时预览</label>
              <div id="font-preview">
                <p style="font-size: 20px; margin: 0 0 10px 0">你好世界 Hello World</p>
                <p style="margin: 0">这是字体预览效果，12345。</p>
              </div>
            </div>
            <button type="button" class="form-button" id="save-font-btn">保存并应用</button>
            <button type="button" class="form-button form-button-secondary" id="reset-font-btn">
              恢复默认字体
            </button>
          </div>
        </div>

        <div id="contact-picker-screen" class="screen">
          <div class="header">
            <button type="button" class="back-btn" id="cancel-contact-picker-btn">取消</button>
            <span>选择联系人</span>
            <button type="button" class="save-btn" id="confirm-contact-picker-btn">完成(0)</button>
          </div>
          <div class="list-container" id="contact-picker-list"></div>
        </div>

        <div id="member-management-screen" class="screen">
          <div class="header">
            <button type="button" class="back-btn" id="back-from-member-management">‹</button>
            <span>群成员管理</span>
            <span style="width: 30px"></span>
          </div>
          <div class="list-container" id="member-management-list"></div>
          <div id="member-management-actions">
            <button type="button" id="add-existing-contact-btn">从好友列表添加</button>
            <button type="button" id="create-new-member-btn">创建群内新成员</button>
          </div>
        </div>

        <div id="incoming-call-modal" class="modal">
          <div class="incoming-call-content">
            <img id="caller-avatar" class="caller-avatar" src="" />
            <div id="caller-name" class="caller-name"></div>
            <div class="caller-text">邀请你视频通话</div>
            <div class="incoming-call-actions">
              <div class="action-button-wrapper">
                <button
                  type="button"
                  id="decline-call-btn"
                  class="call-action-btn decline"
                ></button>
                <span>拒绝</span>
              </div>
              <div class="action-button-wrapper">
                <button type="button" id="accept-call-btn" class="call-action-btn accept"></button>
                <span>接听</span>
              </div>
            </div>
          </div>
        </div>

        <div id="video-call-screen" class="screen">
          <div class="video-call-top-bar">
            <span id="call-timer">00:00</span>
          </div>
          <div class="video-call-avatar-area">
            <div id="participant-avatars-grid"></div>
          </div>
          <div id="video-call-main" class="video-call-main"></div>
          <div class="video-call-controls">
            <button type="button" id="user-speak-btn" class="control-btn speak-btn"></button>
            <button type="button" id="hang-up-btn" class="control-btn hangup-btn"></button>
            <button
              type="button"
              id="join-call-btn"
              class="control-btn join-btn"
              style="display: none"
            ></button>
          </div>
        </div>

        <div id="outgoing-call-screen" class="screen">
          <div class="outgoing-call-content">
            <img id="outgoing-call-avatar" class="caller-avatar" src="" />
            <div id="outgoing-call-name" class="caller-name"></div>
            <div class="caller-text">正在呼叫...</div>
            <div class="outgoing-call-actions">
              <button type="button" id="cancel-call-btn" class="call-action-btn decline"></button>
              <span>取消</span>
            </div>
          </div>
        </div>

        <div id="call-history-screen" class="screen">
          <div class="header">
            <button type="button" class="back-btn" id="call-history-back-btn">‹</button>
            <span id="call-history-title">通话记录</span>
            <span style="width: 30px"></span>
          </div>
          <div
            id="call-history-list"
            class="list-container"
            style="padding: 15px; display: flex; flex-direction: column; gap: 15px"
          ></div>
        </div>
      </div>
    </div>

    <div id="chat-settings-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header"><span>聊天设置</span></div>
        <div class="modal-body">
          <div class="form-group" id="chat-name-group">
            <label for="chat-name-input">备注名 / 群名</label
            ><input type="text" id="chat-name-input" />
          </div>

          <div class="form-group" id="assign-group-section" style="display: none">
            <label for="assign-group-select">好友分组</label>
            <div style="display: flex; align-items: center; gap: 10px">
              <select id="assign-group-select" style="flex-grow: 1"></select>
              <button
                type="button"
                id="manage-groups-btn"
                class="form-button-secondary"
                style="margin-top: 0; padding: 12px"
              >
                管理分组
              </button>
            </div>
          </div>

          <div class="form-group" id="my-group-nickname-group">
            <label for="my-group-nickname-input">我的群昵称</label
            ><input type="text" id="my-group-nickname-input" />
          </div>
          <div class="form-group" id="group-avatar-group">
            <label>群头像</label>
            <div class="avatar-upload">
              <img id="group-avatar-preview" /><button
                type="button"
                onclick="document.getElementById('group-avatar-input').click()"
              >
                上传群头像</button
              ><input type="file" id="group-avatar-input" accept="image/*" />
            </div>
          </div>
          <div class="form-group" id="world-book-link-group">
            <label>关联世界书 (可多选)</label>
            <div class="custom-multiselect">
              <div class="select-box">
                <span class="selected-options-text">-- 点击选择 --</span>
                <span class="arrow-down">▼</span>
              </div>
              <div id="world-book-checkboxes-container" class="checkboxes-container"></div>
            </div>
          </div>
          <div class="form-group" id="ai-persona-group">
            <label for="ai-persona">对方人设 (AI Persona)</label
            ><textarea id="ai-persona" rows="3"></textarea>
          </div>
          <div class="form-group" id="ai-avatar-group">
            <label>对方头像</label>
            <div class="avatar-upload">
              <img id="ai-avatar-preview" />
              <button type="button" onclick="document.getElementById('ai-avatar-input').click()">
                上传对方头像
              </button>
              <button type="button" id="manage-ai-avatar-library-btn">管理头像库</button>
              <input type="file" id="ai-avatar-input" accept="image/*" />
            </div>
          </div>
          <div class="form-group" id="my-persona-group">
            <label for="my-persona">我的人设 (My Persona)</label
            ><textarea id="my-persona" rows="3"></textarea>
          </div>
          <div class="form-group" id="my-avatar-group">
            <label>我的头像</label>
            <div class="avatar-upload">
              <img id="my-avatar-preview" />
              <button type="button" onclick="document.getElementById('my-avatar-input').click()">
                上传我的头像
              </button>
              <button type="button" id="open-persona-library-btn">预设</button>
              <input type="file" id="my-avatar-input" accept="image/*" />
            </div>
          </div>
          <div class="form-group" id="group-members-group">
            <label>群成员人设</label>
            <div id="group-members-settings"></div>
            <button
              type="button"
              id="manage-members-btn"
              class="form-button form-button-secondary"
              style="margin-top: 15px"
            >
              管理群成员
            </button>
          </div>
          <div class="form-group">
            <label for="max-memory">上下文记忆条数</label
            ><input type="number" id="max-memory" value="10" />
          </div>
          <div class="form-group">
            <label>聊天气泡主题 <button id="reset-theme-btn" type="button">重置</button></label>
            <div class="theme-selector">
              <label
                ><input type="radio" name="theme-select" value="default" id="theme-default" />
                默认</label
              ><label><input type="radio" name="theme-select" value="pink_blue" /> 粉蓝</label
              ><label><input type="radio" name="theme-select" value="blue_white" /> 蓝白</label
              ><label><input type="radio" name="theme-select" value="purple_yellow" /> 紫黄</label
              ><label><input type="radio" name="theme-select" value="black_white" /> 黑白</label
              ><label><input type="radio" name="theme-select" value="yellow_white" /> 黄白</label
              ><label><input type="radio" name="theme-select" value="red_black" /> 红黑</label
              ><label><input type="radio" name="theme-select" value="blue_yellow" /> 蓝黄</label
              ><label><input type="radio" name="theme-select" value="pink_yellow" /> 粉黄</label
              ><label><input type="radio" name="theme-select" value="pink_purple" /> 粉紫</label
              ><label><input type="radio" name="theme-select" value="gray_white" /> 灰白</label
              ><label><input type="radio" name="theme-select" value="blue_green" /> 蓝绿</label
              ><label><input type="radio" name="theme-select" value="pink_white" /> 粉白</label
              ><label><input type="radio" name="theme-select" value="pink_black" /> 粉黑</label
              ><label><input type="radio" name="theme-select" value="pink_green" /> 粉绿</label
              ><label><input type="radio" name="theme-select" value="green_black" /> 绿黑</label>
            </div>
          </div>
          <div class="form-group">
            <label for="font-size-slider"
              >聊天字体大小 <span id="font-size-value">13px</span></label
            >
            <input
              type="range"
              id="font-size-slider"
              min="12"
              max="20"
              step="1"
              value="13"
              style="width: 100%; margin-top: 8px"
            />
          </div>
          <div class="form-group">
            <label for="custom-css-input">
              自定义气泡样式 (CSS)
              <button
                id="reset-custom-css-btn"
                type="button"
                style="
                  background: none;
                  border: 1px solid #ccc;
                  color: #555;
                  font-size: 12px;
                  padding: 2px 8px;
                  border-radius: 5px;
                  cursor: pointer;
                  margin-left: 10px;
                "
              >
                重置
              </button>
            </label>
            <textarea
              id="custom-css-input"
              rows="5"
              style="
                width: 100%;
                margin-top: 8px;
                font-family: monospace;
                font-size: 12px;
                resize: vertical;
              "
              placeholder="/* 示例：为“我”的气泡添加渐变背景和阴影 */
.message-bubble.user .content {
  background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  border-radius: 15px 4px 15px 15px;
}"
            ></textarea>
          </div>
          <div class="form-group">
            <label>实时预览</label>
            <div id="settings-preview-area"></div>
          </div>
          <div class="form-group">
            <label>聊天背景</label>
            <div class="bg-upload-container">
              <button
                type="button"
                class="form-button-secondary"
                style="width: auto; padding: 8px 12px; margin-top: 0"
                onclick="document.getElementById('bg-input').click()"
              >
                上传背景图
              </button>
              <button type="button" id="remove-bg-btn">移除背景</button>
            </div>
            <img id="bg-preview" class="bg-preview-img" />
            <input type="file" id="bg-input" accept="image/*" style="display: none" />
          </div>
          <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee" />
          <button
            type="button"
            class="form-button form-button-secondary"
            id="block-chat-btn"
            style="background-color: #ff3b30; color: white; border-color: #ff3b30"
          >
            拉黑对方
          </button>
          <button type="button" class="form-button form-button-secondary" id="clear-chat-btn">
            清空聊天记录
          </button>
        </div>
        <div class="modal-footer">
          <button type="button" class="cancel" id="cancel-chat-settings-btn">取消</button>
          <button type="button" class="save" id="save-chat-settings-btn">保存</button>
        </div>
      </div>
    </div>

    <div id="persona-library-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span>我的人设库</span
          ><button id="add-persona-preset-btn" class="action-button">添加</button>
        </div>
        <div class="modal-body">
          <div id="persona-library-grid"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="cancel" id="close-persona-library-btn">关闭</button>
        </div>
      </div>
    </div>

    <div id="persona-editor-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header"><span id="persona-editor-title">添加人设预设</span></div>
        <div class="modal-body">
          <div class="form-group">
            <label>预设头像</label>
            <div class="avatar-upload">
              <img id="preset-avatar-preview" /><button
                type="button"
                onclick="document.getElementById('preset-avatar-input').click()"
              >
                上传头像</button
              ><input type="file" id="preset-avatar-input" accept="image/*" />
            </div>
          </div>
          <div class="form-group">
            <label for="preset-persona-input">预设人设</label
            ><textarea
              id="preset-persona-input"
              rows="4"
              placeholder="在此输入这个人设的详细设定..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="cancel" id="cancel-persona-editor-btn">取消</button>
          <button type="button" class="save" id="save-persona-preset-btn">保存</button>
        </div>
      </div>
    </div>

    <div id="member-settings-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header"><span>编辑群成员</span></div>
        <div class="modal-body">
          <div class="form-group">
            <label for="member-name-input">名字</label><input type="text" id="member-name-input" />
          </div>
          <div class="form-group">
            <label for="member-persona-input">人设</label
            ><textarea id="member-persona-input" rows="4"></textarea>
          </div>
          <div class="form-group">
            <label>头像</label>
            <div class="avatar-upload">
              <img id="member-avatar-preview" /><button
                type="button"
                onclick="document.getElementById('member-avatar-input').click()"
              >
                上传头像</button
              ><input type="file" id="member-avatar-input" accept="image/*" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="cancel" id="cancel-member-settings-btn">取消</button>
          <button type="button" class="save" id="save-member-settings-btn">保存</button>
        </div>
      </div>
    </div>

    <div id="custom-modal-overlay">
      <div id="custom-modal">
        <div class="custom-modal-header" id="custom-modal-title"></div>
        <div class="custom-modal-body" id="custom-modal-body"></div>
        <div class="custom-modal-footer">
          <button type="button" id="custom-modal-cancel">取消</button>
          <button type="button" id="custom-modal-confirm" class="confirm-btn">确定</button>
        </div>
      </div>
    </div>

    <div id="preset-actions-modal" class="modal">
      <div id="custom-modal" style="width: 250px">
        <div class="custom-modal-footer">
          <button type="button" id="preset-action-edit">编辑预设</button>
          <button type="button" id="preset-action-delete" class="btn-danger">删除预设</button>
          <button
            type="button"
            id="preset-action-cancel"
            style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0"
          >
            取消
          </button>
        </div>
      </div>
    </div>

    <div id="transfer-modal">
      <div class="transfer-content">
        <div class="transfer-header">给Ta一个惊喜！</div>
        <div class="transfer-input-group">
          <label for="transfer-amount">转账金额</label>
          <input
            type="number"
            id="transfer-amount"
            placeholder="0.00"
            min="0"
            max="9999"
            step="0.01"
          />
        </div>
        <div class="transfer-input-group">
          <label for="transfer-note">备注 (可选)</label>
          <input type="text" id="transfer-note" placeholder="留下你的小心思~" maxlength="20" />
        </div>
        <div class="transfer-actions">
          <button type="button" id="transfer-cancel-btn">取消</button>
          <button type="button" id="transfer-confirm-btn">确认转账</button>
        </div>
      </div>
    </div>

    <div id="battery-alert-modal">
      <div class="battery-alert-content">
        <img id="battery-alert-image" src="" />
        <p id="battery-alert-text"></p>
      </div>
    </div>

    <audio id="audio-player" style="display: none"></audio>

    <div id="create-post-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 90%">
        <div class="modal-header">
          <span>发布动态</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <textarea
              id="post-public-text"
              rows="3"
              placeholder="分享新鲜事...（非必填的公开文字）"
            ></textarea>
          </div>
          <div class="post-mode-switcher">
            <button type="button" id="switch-to-image-mode" class="mode-btn active">
              上传图片
            </button>
            <button type="button" id="switch-to-text-image-mode" class="mode-btn">
              使用文字图
            </button>
          </div>
          <div class="form-group">
            <label>可见范围</label>
            <div id="post-visibility-options" style="display: flex; gap: 15px; margin-bottom: 10px">
              <label><input type="radio" name="visibility" value="public" checked /> 公开</label>
              <label><input type="radio" name="visibility" value="include" /> 指定分组可见</label>
            </div>
            <div
              id="post-visibility-groups"
              style="
                display: none;
                max-height: 120px;
                overflow-y: auto;
                background: #f9f9f9;
                padding: 10px;
                border-radius: 8px;
              "
            ></div>
          </div>
          <div id="image-mode-content" class="post-mode-content active">
            <div class="form-group">
              <div id="post-image-preview-container" class="post-image-preview-container">
                <img id="post-image-preview" src="" alt="图片预览" />
                <button type="button" id="post-remove-image-btn">×</button>
              </div>
              <div class="post-image-upload-options">
                <button type="button" id="post-upload-local-btn" class="form-button-secondary">
                  本地上传
                </button>
                <button type="button" id="post-use-url-btn" class="form-button-secondary">
                  网络URL
                </button>
                <input type="file" id="post-local-image-input" accept="image/*" hidden />
              </div>
            </div>
            <div id="post-image-desc-group" class="form-group" style="display: none">
              <label>图片描述 (必填，给AI看)</label>
              <input
                type="text"
                id="post-image-description"
                placeholder="简单描述图片内容，帮助AI理解"
              />
            </div>
          </div>
          <div id="text-image-mode-content" class="post-mode-content">
            <div class="form-group">
              <label>文字图 (给AI理解用的描述，点击图片后可见)</label>
              <textarea
                id="post-hidden-text"
                rows="4"
                placeholder="在这里写下图片描述..."
              ></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="cancel" id="cancel-create-post-btn">取消</button>
          <button type="button" class="save" id="confirm-create-post-btn">发布</button>
        </div>
      </div>
    </div>

    <div id="group-management-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>管理好友分组</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>新建分组</label>
            <div style="display: flex; gap: 10px">
              <input
                type="text"
                id="new-group-name-input"
                placeholder="输入分组名..."
                style="flex-grow: 1"
              />
              <button
                type="button"
                id="add-new-group-btn"
                class="form-button"
                style="width: auto; margin-top: 0; padding: 0 15px"
              >
                添加
              </button>
            </div>
          </div>
          <hr style="opacity: 0.2" />
          <div
            id="existing-groups-list"
            style="display: flex; flex-direction: column; gap: 10px"
          ></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="save" id="close-group-manager-btn" style="width: 100%">
            完成
          </button>
        </div>
      </div>
    </div>

    <div id="message-actions-modal" class="modal">
      <div id="custom-modal" style="width: 250px">
        <div class="custom-modal-footer">
          <button type="button" id="edit-message-btn">编辑消息</button>
          <button type="button" id="copy-message-btn">复制文本</button>
          <button type="button" id="recall-message-btn">撤回</button>
          <button type="button" id="quote-message-btn">引用</button>
          <button type="button" id="select-message-btn">进入多选</button>
          <button
            type="button"
            id="cancel-message-action-btn"
            style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0"
          >
            取消
          </button>
        </div>
      </div>
    </div>

    <div id="post-actions-modal" class="modal">
      <div id="custom-modal" style="width: 250px">
        <div class="custom-modal-footer">
          <button type="button" id="edit-post-btn">编辑动态</button>
          <button type="button" id="copy-post-btn">复制内容</button>
          <button type="button" id="cancel-post-action-btn">取消</button>
        </div>
      </div>
    </div>

    <div id="message-editor-modal" class="modal">
      <div class="modal-content" style="height: 75%">
        <div class="modal-header">
          <span>编辑与拆分消息</span>
        </div>
        <div class="modal-body" id="message-editor-body">
          <div id="message-editor-container"></div>
          <button
            type="button"
            id="add-message-editor-block-btn"
            class="form-button form-button-secondary"
            style="margin-top: 15px"
          >
            [+] 添加下一条消息
          </button>
        </div>
        <div class="modal-footer">
          <button type="button" class="cancel" id="cancel-advanced-editor-btn">取消</button>
          <button type="button" class="save" id="save-advanced-editor-btn">保存更改</button>
        </div>
      </div>
    </div>

    <div id="waimai-request-modal" class="modal">
      <div class="modal-content" style="width: 290px">
        <div class="modal-header">
          <span>发起外卖代付</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="waimai-product-info">商品信息</label>
            <input type="text" id="waimai-product-info" placeholder="例如：一杯杨枝甘露" />
          </div>
          <div class="form-group">
            <label for="waimai-amount">代付金额 (元)</label>
            <input type="number" id="waimai-amount" placeholder="例如：21" min="0" step="0.01" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="cancel" id="waimai-cancel-btn">取消</button>
          <button type="button" class="save" id="waimai-confirm-btn">发起请求</button>
        </div>
      </div>
    </div>

    <div id="create-countdown-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>新建约定</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="countdown-title-input">约定标题</label>
            <input type="text" id="countdown-title-input" placeholder="例如：我的生日" />
          </div>
          <div class="form-group">
            <label for="countdown-date-input">约定日期与时间</label>
            <input type="datetime-local" id="countdown-date-input" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="cancel" id="cancel-create-countdown-btn">取消</button>
          <button type="button" class="save" id="confirm-create-countdown-btn">保存约定</button>
        </div>
      </div>
    </div>

    <div id="red-packet-modal" class="modal">
      <div class="modal-content" style="width: 300px; height: auto">
        <div class="modal-header">
          <span>发红包</span>
        </div>
        <div class="modal-body" style="padding: 0">
          <div class="frame-tabs">
            <div id="rp-tab-group" class="frame-tab active">拼手气红包</div>
            <div id="rp-tab-direct" class="frame-tab">专属红包</div>
          </div>
          <div id="rp-content-group" class="frame-content" style="padding: 20px 15px">
            <div class="form-group">
              <label>总金额 (元)</label>
              <input type="number" id="rp-group-amount" placeholder="0.00" />
            </div>
            <div class="form-group">
              <label>红包个数</label>
              <input type="number" id="rp-group-count" placeholder="填写红包个数" />
            </div>
            <div class="form-group">
              <label>祝福语</label>
              <input type="text" id="rp-group-greeting" placeholder="恭喜发财，大吉大利！" />
            </div>
            <p
              id="rp-group-total"
              style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0"
            >
              ¥ 0.00
            </p>
            <button type="button" id="send-group-packet-btn" class="form-button">塞钱进红包</button>
          </div>
          <div
            id="rp-content-direct"
            class="frame-content"
            style="display: none; padding: 20px 15px"
          >
            <div class="form-group">
              <label>发送给</label>
              <select id="rp-direct-receiver"></select>
            </div>
            <div class="form-group">
              <label>金额 (元)</label>
              <input type="number" id="rp-direct-amount" placeholder="0.00" />
            </div>
            <div class="form-group">
              <label>祝福语</label>
              <input type="text" id="rp-direct-greeting" placeholder="恭喜发财，大吉大利！" />
            </div>
            <p
              id="rp-direct-total"
              style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0"
            >
              ¥ 0.00
            </p>
            <button type="button" id="send-direct-packet-btn" class="form-button">
              塞钱进红包
            </button>
          </div>
        </div>
        <div class="modal-footer" style="justify-content: center">
          <button type="button" class="cancel" id="cancel-red-packet-btn" style="width: 100%">
            取消
          </button>
        </div>
      </div>
    </div>

    <div id="red-packet-details-modal" class="modal">
      <div class="modal-content" style="width: 280px; height: auto; background-color: #f7f7f7">
        <div
          class="modal-header"
          style="background-color: #f96259; color: white; border-bottom: none; padding-bottom: 5px"
        >
          <div style="text-align: center; width: 100%">
            <div id="rp-details-sender" style="font-size: 16px"></div>
            <div style="font-size: 13px; opacity: 0.8">的红包</div>
          </div>
        </div>
        <div class="modal-body" style="padding: 15px">
          <p
            id="rp-details-greeting"
            style="text-align: center; font-size: 20px; color: #333; margin: 0 0 20px 0"
          ></p>
          <div
            id="rp-details-my-amount"
            style="text-align: center; display: none; margin-bottom: 20px"
          >
            <span style="font-size: 40px; font-weight: bold; color: #e44d44">0.00</span>
            <span style="font-size: 18px; color: #e44d44">元</span>
          </div>
          <div
            id="rp-details-summary"
            style="
              font-size: 13px;
              color: #8a8a8a;
              border-top: 1px solid #e0e0e0;
              padding-top: 10px;
            "
          ></div>
          <div
            id="rp-details-list"
            style="max-height: 150px; overflow-y: auto; margin-top: 10px"
          ></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="save" id="close-rp-details-btn" style="width: 100%">
            关闭
          </button>
        </div>
      </div>
    </div>

    <div id="create-poll-modal" class="modal">
      <div class="modal-content" style="width: 300px; height: auto">
        <div class="modal-header">
          <span>发起投票</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="poll-question-input">投票问题</label>
            <textarea
              id="poll-question-input"
              rows="2"
              placeholder="例如：今晚我们看什么电影？"
            ></textarea>
          </div>
          <div class="form-group">
            <label>投票选项 (至少2项)</label>
            <div
              id="poll-options-container"
              style="display: flex; flex-direction: column; gap: 8px"
            ></div>
            <button
              type="button"
              id="add-poll-option-btn"
              class="form-button form-button-secondary"
              style="margin-top: 12px"
            >
              + 添加选项
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="cancel" id="cancel-create-poll-btn">取消</button>
          <button type="button" class="save" id="confirm-create-poll-btn">发起投票</button>
        </div>
      </div>
    </div>

    <div id="ai-avatar-library-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span id="ai-avatar-library-title">对方的头像库</span>
          <button type="button" id="add-ai-avatar-btn" class="action-button">添加</button>
        </div>
        <div class="modal-body" style="padding: 15px">
          <div
            id="ai-avatar-library-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
              gap: 15px;
            "
          ></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="save" id="close-ai-avatar-library-btn" style="width: 100%">
            关闭
          </button>
        </div>
      </div>
    </div>

    <div id="share-link-modal" class="modal">
      <div class="modal-content" style="width: 300px; height: auto">
        <div class="modal-header">
          <span>分享链接</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="link-title-input">标题</label>
            <input type="text" id="link-title-input" placeholder="输入文章或链接的标题" />
          </div>
          <div class="form-group">
            <label for="link-description-input">摘要 (可选)</label>
            <textarea
              id="link-description-input"
              rows="2"
              placeholder="简单描述一下链接内容"
            ></textarea>
          </div>
          <div class="form-group">
            <label for="link-source-input">来源名称 (可选)</label>
            <input type="text" id="link-source-input" placeholder="例如：知乎日报、B站" />
          </div>
          <div class="form-group">
            <label for="link-content-input">完整内容 (可选，用于浏览器内显示)</label>
            <textarea
              id="link-content-input"
              rows="4"
              placeholder="粘贴或输入完整的文章内容"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="cancel" id="cancel-share-link-btn">取消</button>
          <button type="button" class="save" id="confirm-share-link-btn">分享</button>
        </div>
      </div>
    </div>

    <div id="transfer-actions-modal" class="modal">
      <div class="transfer-actions-content">
        <div class="transfer-actions-header">请选择操作</div>
        <div class="transfer-actions-body">
          <p>你收到了来自 <strong id="transfer-sender-name"></strong> 的一笔转账。</p>
        </div>
        <div class="transfer-actions-footer">
          <button type="button" id="transfer-action-decline" class="action-btn decline">
            残忍拒绝
          </button>
          <button type="button" id="transfer-action-accept" class="action-btn accept">
            开心收下
          </button>
        </div>
        <button type="button" id="transfer-action-cancel" class="cancel-btn">×</button>
      </div>
    </div>

    <div id="call-transcript-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span id="transcript-modal-title">通话详情</span>
        </div>
        <div class="modal-body" id="transcript-modal-body" style="background-color: #f0f2f5"></div>
        <div class="modal-footer">
          <button
            type="button"
            class="cancel"
            id="delete-transcript-btn"
            style="background-color: #ff3b30; color: white; border-color: #ff3b30"
          >
            删除记录
          </button>
          <button type="button" class="save" id="close-transcript-modal-btn" style="width: 100%">
            关闭
          </button>
        </div>
      </div>
    </div>

    <div id="share-target-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>分享到...</span>
        </div>
        <div class="modal-body" id="share-target-list" style="padding: 0"></div>
        <div class="modal-footer">
          <button type="button" class="cancel" id="cancel-share-target-btn">取消</button>
          <button type="button" class="save" id="confirm-share-target-btn">确认分享</button>
        </div>
      </div>
    </div>

    <div id="shared-history-viewer-modal" class="modal">
      <div class="modal-content" style="height: 80%">
        <div class="modal-header">
          <span id="shared-history-viewer-title">聊天记录</span>
        </div>
        <div
          class="modal-body"
          id="shared-history-viewer-content"
          style="background-color: #f0f2f5"
        ></div>
        <div class="modal-footer">
          <button
            type="button"
            class="save"
            id="close-shared-history-viewer-btn"
            style="width: 100%"
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <div id="world-book-category-manager-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>管理世界书分类</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>新建分类</label>
            <div style="display: flex; gap: 10px">
              <input
                type="text"
                id="new-category-name-input"
                placeholder="输入分类名..."
                style="flex-grow: 1"
              />
              <button
                type="button"
                id="add-new-category-btn"
                class="form-button"
                style="width: auto; margin-top: 0; padding: 0 15px"
              >
                添加
              </button>
            </div>
          </div>
          <hr style="opacity: 0.2" />
          <div
            id="existing-categories-list"
            style="display: flex; flex-direction: column; gap: 10px"
          ></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="save" id="close-category-manager-btn" style="width: 100%">
            完成
          </button>
        </div>
      </div>
    </div>
    <div id="api-config-editor-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 90%">
        <div class="modal-header">
          <span>编辑API配置</span>
        </div>
        <div class="modal-body">
          <input type="hidden" id="config-editor-id" />
          <div class="form-group">
            <label for="config-name-input">配置名称</label>
            <input type="text" id="config-name-input" placeholder="例如：主力模型、备用线路" />
          </div>
          <div class="form-group">
            <label for="config-url-input">反代地址</label>
            <input type="text" id="config-url-input" placeholder="例如: https://api.openai.com" />
          </div>
          <div class="form-group">
            <label for="config-key-input">密钥</label>
            <input type="password" id="config-key-input" placeholder="sk-..." />
          </div>
          <div class="form-group">
            <label for="config-model-select">默认模型</label>
            <select id="config-model-select"></select>
            <button
              type="button"
              class="form-button-secondary"
              id="config-fetch-models-btn"
              style="margin-top: 10px"
            >
              拉取模型列表
            </button>
          </div>
          <div class="form-group form-group-flex">
            <label for="config-stream-switch" style="margin-bottom: 0">启用流式传输</label>
            <label class="toggle-switch">
              <input type="checkbox" id="config-stream-switch" />
              <span class="slider"></span>
            </label>
          </div>
          <div class="form-group form-group-flex">
            <label for="config-hide-stream-switch" style="margin-bottom: 0">隐藏流式响应</label>
            <label class="toggle-switch">
              <input type="checkbox" id="config-hide-stream-switch" />
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="cancel" id="cancel-config-editor-btn">取消</button>
          <button type="button" class="save" id="save-config-btn">保存</button>
        </div>
      </div>
    </div>
    <script src="script.js"></script>

    <div id="update-notification">应用有新版本可用，请 <a id="reload-page">刷新</a> 更新。</div>
    <script src="sw-register.js" defer></script>
  </body>
</html>
